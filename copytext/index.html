<!DOCTYPE html>
<html lang="ru">
<head>
<!-- title -->
<title>Клонирование текста</title>
<!-- title -->
<!-- meta -->
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<!-- meta -->
<!-- style -->
<link rel="stylesheet" type="text/css" href="../assets/style/all.css" />
<style>
input[type="text"], input[type="number"] {
	width: 100px;
}

.isapi td {
	color: #333;
	background-color: #fff;
	border: 1px solid #ddd;
	padding-bottom: 2px;
	padding-top: 2px;
	padding-left: 10px;
	padding-right: 10px;
	text-align: center;
}

#in, #out {
	padding: 10px;
	display: block;
	min-height: 160px;
	width: 100%;
	resize: vertical;
	background-color: #eee;
	font-family: monospace;
	color: #000;
	font-size: 14px;
	border: 1px solid #6699CC;
	-webkit-box-sizing: border-box;
	-moz-box-sizing: border-box;
	box-sizing: border-box;
	border-radius: 3px;
}

#inkey, #outkey {
	text-align: right;
	width: 100%;
}

.svgx, .svgx:after {
	display: inline-block;
	width: 24px;
	height: 24px;
}

.svgx {
	border: 1px solid #6699CC;
	padding: 3px;
	margin-left: 5px;
	border-radius: 3px;
}

.svgx:hover {
	background-color: #6699CC;
}

.svgx:after {
	content: " ";
	background-color: #6699CC;
	mask-repeat: no-repeat;
	-webkit-mask-repeat: no-repeat;
}

.svgx:hover:after {
	background-color: #FFF;
}

.dl:after {
	mask-image: url('https://xdiloc.github.io/assets/icon/svg/dl.svg');
	-webkit-mask-image: url('https://xdiloc.github.io/assets/icon/svg/dl.svg');
}

.cp:after {
	mask-image: url('https://xdiloc.github.io/assets/icon/svg/cp.svg');
	-webkit-mask-image: url('https://xdiloc.github.io/assets/icon/svg/cp.svg');
}

.rm:after {
	mask-image: url('https://xdiloc.github.io/assets/icon/svg/rm.svg');
	-webkit-mask-image: url('https://xdiloc.github.io/assets/icon/svg/rm.svg');
}

.sl:after {
	mask-image: url('https://xdiloc.github.io/assets/icon/svg/sl.svg');
	-webkit-mask-image: url('https://xdiloc.github.io/assets/icon/svg/sl.svg');
}
</style>
<!-- style -->
</head>
<body>

<script>
function x_delid(dd) {
	document.getElementById(dd).remove();
}

function x_spec(dd) {
	dd = dd.replaceAll(/(\\s)/g, ' ');
	dd = dd.replaceAll(/(\\t)|(\s{4})/g, '\t');
	dd = dd.replaceAll(/(\\r)|(\\n)/g, '\n');
	return dd;
}

function x_nan(n, nmin, nmax) {
	let c = parseInt(n);
	if (isNaN(c) || n != c || c < nmin || c > nmax) return true;
	return false;
}

function x_seturl(dd, text) {
	document.getElementById(dd).href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(text);
}

var setup = false;
function x_load() {
	let inp = document.getElementById('in');
	let out = document.getElementById('out');
	let sum = document.getElementById('sum');
	let step = document.getElementById('step');
	out.value = '';
	out.placeholder = '';

	let check = false;
	if (inp.value.length == 0) check = true;
	if (x_nan(sum.value, 1, 3000)) {
		sum.value = '';
		out.placeholder = 'Введите число повторений от 1 до 3000';
		check = true;
	}
	if (x_nan(step.value, 1, 3000)) {
		step.value = '';
		out.placeholder = 'Введите число шаг разделителя от 1 до 3000';
		check = true;
	}
	let sep2 = document.getElementById('sep2');
	let sepend2 = document.getElementById('sepend2');
	let datasep2;
	if (step.value > 1 && check != true) {
		sep2.disabled = false;
		sepend2.disabled = false;
		datasep2 = x_spec(sep2.value);
	} else {
		sep2.disabled = true;
		sepend2.disabled = true;
		datasep2 = '';
	}
	if (check == true) {
		if (setup != false) {
			x_delid('inkey');
			x_delid('outkey');
			setup = false;
		}
		return;
	}
	let prev = new Array();
	/* IEEE-754 suck 1.1*3=3.3000000000000003 */
	function calc(str, p1, p2, p3, offset, s) {
		let out = 'bad', c1;
		p3 = Number(p3);
		if (prev[offset] == undefined) {
			c1 = Number(p1);
			prev[offset] = c1;
			return c1;
		} else {
			c1 = prev[offset];
		}
		if (p2 === '+') out = c1 + p3;
		if (p2 === '-') out = c1 - p3;
		if (p2 === '*') out = c1 * p3;
		if (p2 === '/') out = c1 / p3;
		out = Math.round((out + Number.EPSILON) * 100) / 100;
		prev[offset] = out;
		return out;
	}
	let sep1 = document.getElementById('sep1');
	let sepend1 = document.getElementById('sepend1');
	let data = x_spec(inp.value), datasep1 = x_spec(sep1.value);
	let num = 1, cache, com = '';
	while (num <= sum.value) {
		if (num % step.value == 0) {
			if (num == sum.value && sepend1.checked == false) datasep1 = '';
			cache = data + datasep1;
		} else {
			if (step.value > 1) {
				if (num == sum.value && sepend2.checked == false) datasep2 = '';
				cache = data + datasep2;
			} else {
				cache = data;
			}
		}
		cache = cache.replaceAll(/calc\((\d*\.{1}\d+|\d+)([\+|\-|\*|\/])(\d*\.{1}\d+|\d+)\)/g, calc);
		com += cache;
		num++;
	}
	out.value = com;

	if (setup != true) {
		inp.insertAdjacentHTML('afterend', '<div id=\"inkey\"><a class=\"rm svgx\" href=\"javascript:x_clear(\'in\', 1);\" title=\"Очистить текст\"></a><a class=\"cp svgx\" href=\"javascript:x_ccopy(\'in\');\" title=\"Копировать текст в буфер обмена\"></a><a class=\"dl svgx\" id=\"savein\" target=\"_blank\" download=\"saveit.txt\" title=\"Сохранить в фаил\"></a></div>');
		out.insertAdjacentHTML('afterend', '<div id=\"outkey\"><a class=\"sl svgx\" href=\"javascript:x_cselect(\'out\');\" title=\"Выделить текст\"></a><a class=\"cp svgx\" href=\"javascript:x_ccopy(\'out\');\" title=\"Копировать текст в буфер обмена\"></a><a class=\"dl svgx\" id=\"saveout\" target=\"_blank\" download=\"saveit.txt\" title=\"Сохранить в фаил\"></a></div>');
		setup = true;
	}
	x_seturl('savein', inp.value);
	x_seturl('saveout', com);
}

function x_clear(dd, ask) {
	let ww = document.getElementById(dd);
	if (ww.value.length == 0) return;
	if (ask == 1) {
		if (confirm('Вы уверены что хотите очистить текст?') == false) return;
	}
	ww.value = '';
	x_load();
}

function x_ccopy(dd) {
	document.getElementById(dd).select();
	document.execCommand('copy');
}

function x_cselect(dd) {
	document.getElementById(dd).select();
}
</script>

<div id="wrapper">
<div id="content">
<h2>Клонирование текста</h2>
<hr />
<div class="pack">
<div class="box" style="padding-right: 10px;">
<textarea id="in" oninput="x_load();" placeholder="Введите сюда текст для клонирования" autofocus></textarea>
<textarea id="out" readonly></textarea>
</div>
<div class="box" style="padding-left: 10px;">
<input type="number" id="sum" oninput="x_load();" min="1" max="3000"> Количество повторений (1-3000)
<hr />
<input type="text" id="sep1" oninput="x_load();"> Разделитель (<a href="javascript:x_clear('sep1', 0);" title="очистить">очистить</a>)<br />
<input type="number" id="step" oninput="x_load();" min="1" max="3000"> Шаг разделителя<br />
<label><input type="checkbox" id="sepend1" onchange="x_load();"><span> Разделитель в конце</span></label>
<hr />
<input type="text" id="sep2" oninput="x_load();" disabled> Разделитель (<a href="javascript:x_clear('sep2', 0);" title="очистить">очистить</a>)<br />
<label><input type="checkbox" id="sepend2" onchange="x_load();" disabled><span> Разделитель в конце</span></label>
<hr />
<table class="isapi">
<tr><td colspan="2"><b>calc(1+1)</b></td><td>простые вычисления<br />сложение, вычитание, деление, умножение</td></tr>
<tr><td><b>\r</b></td><td><b>\n</b></td><td>перенос строки</td></tr>
<tr><td colspan="2"><b>\t</b></td><td>табуляция</td></tr>
<tr><td colspan="2"><b>\s</b></td><td>пробел</td></tr>
</table>
</div>
<div id="clear"></div>
</div>
</div>
</div>

<script>
// clear
document.getElementById('sum').value = '5';
document.getElementById('step').value = '1';
x_load();
</script>

<footer id="footer"><div class="we">
<a href="https://xdiloc.github.io/" title="главная страница">xdiloc.github.io</a>
<span> &starf; </span>
<a href="https://github.com/xdiloc/xdiloc.github.io" target="_blank" title="разработка">github.com</a>
</div></footer>

</body>
</html>
